{% extends "base.html" %}
{% block content %}
<div class="container">
    <div class="plant-detail">
        <h1 class="title">{{ plant.title }}</h1>
        <p class="created">–û–ø—É–±–ª–∏–∫–æ–≤–∞–Ω–æ: {{ plant.created_at }}</p>

        <img src="{{ plant.image.url }}" alt="{{ plant.title }}" class="plant-image">
        <p class="description">{{ plant.description }}</p>
         <p>–ê–≤—Ç–æ—Ä:<a href="{%url 'profile_author' slug=plant.author.user.profile.slug%}">{{ plant.author.user.username }}</a></p>
        <p class="category"><strong>–ö–∞—Ç–µ–≥–æ—Ä–∏—è:</strong> <a href="{{ plant.category.get_absolute_url }}">{{ plant.category.title }}</a></p>

        {% if plant.tag.all %}
        <p class="tags">
            <strong>–¢–µ–≥–∏:</strong>
            {% for tag in plant.tag.all %}
                <span class="tag"><a href="{{ tag.get_absolute_url }}">{{ tag.title }}</a></span>
            {% endfor %}
        </p>
        {% endif %}
    </div>

    <!-- –ì–æ–ª–æ—Å–æ–≤–∞–Ω–∏–µ -->
<div class="vote-buttons">
    <button class="vote-btn like-btn" data-plant-id="{{ plant.id }}" data-vote="like">
        {% if user_vote == 1 %}
            ‚ù§Ô∏è
        {% else %}
            ü§ç
        {% endif %}
        <span class="like-count">{{ plant.likes }}</span>
    </button>

    <button class="vote-btn dislike-btn" data-plant-id="{{ plant.id }}" data-vote="dislike">
        {% if user_vote == -1 %}
            üíî
        {% else %}
            ü§ç
        {% endif %}
        <span class="dislike-count">{{ plant.dislikes }}</span>
    </button>
</div>


</div>



<!-- –°–∫—Ä—ã—Ç—ã–π csrf-—Ç–æ–∫–µ–Ω -->
<form style="display: none;">{% csrf_token %}</form>

<!-- JS –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ –≥–æ–ª–æ—Å–æ–≤ -->

<hr class="divider">

<div class="comments-section">
    <h2 class="comments-title">–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏ ({{ comments.paginator.count }})</h2>

    <!-- –°–ø–∏—Å–æ–∫ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤ -->
    <div class="comment-list">
        {% for comment in comments %}
            <div class="comment">
                <div class="comment-header">
                    <a href="{%url 'profile_author' slug=comment.author.profile.slug%}"><strong>{{ comment.author.username }}</strong></a>
                    <span class="comment-date">{{ comment.created_at|date:"d.m.Y" }}</span>
                </div>
                <p class="comment-text">{{ comment.comment}}</p>
            </div>
        {% empty %}
            <p>–ü–æ–∫–∞ –Ω–µ—Ç –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤.</p>
        {% endfor %}
    </div>

    <!-- –ü–∞–≥–∏–Ω–∞—Ü–∏—è -->
    <div class="pagination">
        {% if comments.has_previous %}
            <a href="?page={{ comments.previous_page_number }}">‚Üê –ù–∞–∑–∞–¥</a>
        {% endif %}

        <span>–°—Ç—Ä–∞–Ω–∏—Ü–∞ {{ comments.number }} –∏–∑ {{ comments.paginator.num_pages }}</span>

        {% if comments.has_next %}
            <a href="?page={{ comments.next_page_number }}">–í–ø–µ—Ä—ë–¥ ‚Üí</a>
        {% endif %}
    </div>

    <!-- –§–æ—Ä–º–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏—è -->
<form method="post" action="{% url 'add_comment' slug=plant.slug %}">
    {% csrf_token %}
    {{ comment_form.as_p }}
    <button type="submit">–û—Å—Ç–∞–≤–∏—Ç—å –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π</button>
</form>

<script>
document.addEventListener('DOMContentLoaded', function () {
    const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;

    document.querySelectorAll('.vote-btn').forEach(button => {
        button.addEventListener('click', function () {
            const plantId = this.dataset.plantId;
            const voteType = this.dataset.vote;
            const likeBtn = document.querySelector('.like-btn');
            const dislikeBtn = document.querySelector('.dislike-btn');

            fetch("{% url 'vote' %}", {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                    'X-CSRFToken': csrfToken
                },
                body: new URLSearchParams({
                    'object_id': plantId,
                    'vote': voteType
                })
            })
            .then(response => response.json())
            .then(data => {
                // –û–±–Ω–æ–≤–ª—è–µ–º —Å—á—ë—Ç—á–∏–∫–∏
                document.querySelector('.like-count').textContent = data.likes;
                document.querySelector('.dislike-count').textContent = data.dislikes;

                // –û–±–Ω–æ–≤–ª—è–µ–º –∏–∫–æ–Ω–∫–∏
                if (data.user_vote === 'like') {
                    likeBtn.innerHTML = '‚ù§Ô∏è <span class="like-count">' + data.likes + '</span>';
                    dislikeBtn.innerHTML = 'ü§ç <span class="dislike-count">' + data.dislikes + '</span>';
                } else if (data.user_vote === 'dislike') {
                    likeBtn.innerHTML = 'ü§ç <span class="like-count">' + data.likes + '</span>';
                    dislikeBtn.innerHTML = 'üíî <span class="dislike-count">' + data.dislikes + '</span>';
                } else {
                    likeBtn.innerHTML = 'ü§ç <span class="like-count">' + data.likes + '</span>';
                    dislikeBtn.innerHTML = 'ü§ç <span class="dislike-count">' + data.dislikes + '</span>';
                }
            });
        });
    });
});
</script>


{% endblock content %}
